// 4. Запросы для получения уникальных значений

// Все различные названия товариществ
MATCH (s:Садовод) RETURN DISTINCT s.товарищество;

// Все различные товарищества, откуда были получены растения
MATCH (r:Растение) RETURN DISTINCT r.откуда;

// Все различные месяцы, когда производились покупки
MATCH (b:Покупка) RETURN DISTINCT b.дата;

// 5. Запросы для получения информации о садоводах и питомниках

// Фамилии и размер льгот садоводов из товарищества "Урожай"
MATCH (s:Садовод) WHERE s.товарищество = 'Урожай' RETURN s.фамилия, s.льгота;

// Фамилии садоводов из товариществ "Радостное" или "Дальнее"
MATCH (s:Садовод) WHERE s.товарищество IN ['Радостное', 'Дальнее'] RETURN s.фамилия;

// Названия и стоимость растений, которые покупались в питомниках товарищества "Мичуринское" или стоящих более 30000 руб.
MATCH (r:Растение)<-[:КУПОНОВАЛ]-(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)
WHERE p.товарищество = 'Мичуринское' OR r.цена > 30000
RETURN DISTINCT r.сорт, r.цена;

// 6. Запросы для вывода покупок с необходимыми данными

// Фамилию садовода и название питомника, где производилась покупка
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)
RETURN s.фамилия, p.название;

// Дату, фамилию садовода, льготу, название и количество купленных растений
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)<-[:КУПОНОВАЛ]-(r:Растение)
RETURN b.дата, s.фамилия, s.льгота, r.сорт, b.количество;

// 7a. Определение номера ведомости и даты покупки
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)
WHERE b.итоговая_стоимость >= 60000
RETURN b.номер_ведомости, s.фамилия, b.дата;

// 7b. Покупки садоводов в питомниках своего товарищества не ранее марта
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)
WHERE p.товарищество = s.товарищество AND b.дата IN ['Март', 'Апрель', 'Май', 'Июнь']
RETURN s.фамилия, s.товарищество, b.дата ORDER BY s.фамилия, b.дата;

// 7c. Питомники не из "Дальнего" для покупателей с льготой от 1 до 2%
MATCH (p:Питомник)<-[:ПРОДАЛ]-(b:Покупка)<-[:СДЕЛАЛ_ПОКУПКУ]-(s:Садовод)
WHERE s.льгота BETWEEN 1 AND 2 AND p.товарищество <> 'Дальнее'
RETURN DISTINCT p.название;

// 7d. Данные по покупке растений (название, питомник, купленное количество), приобретенных садоводами из того же товарищества
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)<-[:КУПОНОВАЛ]-(r:Растение)
WHERE r.откуда = p.товарищество
RETURN r.сорт, p.название, b.количество, b.итоговая_стоимость ORDER BY b.итоговая_стоимость;

// Уровень 2
// 10 b) Покупки, сделанные садоводом в питомниках своего товарищества не ранее марта
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)
WHERE p.товарищество IN 
      (SELECT товарищество FROM Садовод WHERE идентификатор = b.садовод)
  AND b.дата IN ['Март', 'Апрель', 'Май', 'Июнь']
RETURN s.фамилия, s.товарищество, b.дата ORDER BY s.фамилия, b.дата;
//d) данные по покупке растений (название, питомник, купленное количество), приобретенных садоводами из того же товарищества, которое первоначально предоставило эти растения в питомник.
MATCH (s:Садовод)-[:КУПОНОВАЛ]->(b:Покупка)-[:ПРОДАЛ]->(p:Питомник)-[:ПРЕДОСТАВИЛ]->(r:Растение)
WHERE r.откуда = p.товарищество
RETURN r.сорт AS сорт, p.название AS название, b.кол_во AS купленное_количество, b.итоговая_стоимость AS итоговая_стоимость
ORDER BY b.итоговая_стоимость ASC;

// фамилии садоводов, которые не покупали в питомниках "Мичуринское"
MATCH (s:Садовод)
WHERE NOT EXISTS (
    MATCH (b:Покупка)-[:ПРОДАЛ]->(p:Питомник)
    WHERE p.товарищество = 'Мичуринское' AND b.садовод = s.идентификатор
)
RETURN s.фамилия;

// Фамилии садоводов, покупавших вишни
MATCH (s:Садовод)
WHERE EXISTS (
    MATCH (b:Покупка)-[:КУПОНОВАЛ]->(r:Растение {сорт: 'Вишня'})
    WHERE b.садовод = s.идентификатор
)
RETURN s.фамилия;

// 11. Операции ALL и ANY

// А) Названия растений, продающихся в питомниках “Дальнего” и имеющих наибольшую стоимость
MATCH (r:Растение)
WHERE r.идентификатор IN (
    MATCH (p:Питомник {товарищество: 'Дальнее'})-[:ПРОДАЛ]->(b:Покупка)
    RETURN b.идентификатор
) 
AND r.цена = ANY (
    MATCH (p:Питомник {товарищество: 'Дальнее'})-[:ПРОДАЛ]->(b:Покупка)
    RETURN MAX(b.цена)
)
RETURN r.сорт;

// Б) Фамилии садоводов, имеющих льготы больше минимальных
MATCH (s:Садовод)
WHERE s.льгота > ALL (
    MATCH (s:Садовод) RETURN MIN(s.льгота) 
)
RETURN s.фамилия;

// В) Названия питомников всех товариществ, кроме “Урожай”
MATCH (p:Питомник)
WHERE p.товарищество <> 'Урожай' 
AND p.комиссионные = ANY (
    MATCH (p:Питомник {товарищество: 'Урожай'}) 
    RETURN p.комиссионные
)
RETURN p.название;

// Д) Номер ведомости, фамилию садовода и дату покупки, в которой куплено больше 60000 руб
MATCH (s:Садовод)-[:СДЕЛАЛ_ПОКУПКУ]->(b:Покупка)
WHERE b.итоговая_стоимость >= ALL (
    MATCH (b:Покупка WHERE b.итоговая_стоимость < 60000) RETURN b.итоговая_стоимость
) 
RETURN b.номер_ведомости, s.фамилия, b.дата ORDER BY b.номер_ведомости;

// 12. Операция UNION
MATCH (s:Садовод)
RETURN s.товарищество 
UNION 
MATCH (p:Питомник)
RETURN p.товарищество;

// 13. Операция EXISTS

// А) Найти садоводов, покупавших все растения товарищества “Солнечное” не позднее июня
MATCH (s:Садовод)
WHERE NOT EXISTS (
    MATCH (r:Растение {откуда: 'Солнечное'})
    WHERE NOT EXISTS (
        MATCH (b:Покупка)
        WHERE b.садовод = s.идентификатор AND b.растение = r.идентификатор AND b.дата <= 'Июнь'
    )
)
RETURN s.фамилия;

// Б) Найти растения, которые покупали все садоводы с размером льгот менее 3% из питомников товарищества “Урожай”
MATCH (r:Растение)
WHERE EXISTS (
    MATCH (s:Садовод {льгота < 3, товарищество: 'Урожай'})
    WHERE NOT EXISTS (
        MATCH (p:Покупка)
        WHERE p.садовод = s.идентификатор AND p.растение = r.идентификатор
    )
)
RETURN DISTINCT r;

// В) Найти такие питомники, которые продавали растения всем садоводам со льготами
MATCH (p:Питомник)
WHERE NOT EXISTS (
    MATCH (s:Садовод {льгота > 0})
    WHERE NOT EXISTS (
        MATCH (b:Покупка WHERE b.питомник = p.идентификатор AND b.садовод = s.идентификатор)
    )
)
RETURN p.название;

// Г) Найти садоводов с размером льгот больше минимального, которые покупали растения во всех питомниках
MATCH (s:Садовод)
WHERE s.льгота > (SELECT MIN(льгота) FROM Садовод) 
AND NOT EXISTS (
    MATCH (p:Питомник)
    WHERE NOT EXISTS (
        MATCH (b:Покупка) WHERE b.питомник = p.идентификатор AND b.садовод = s.идентификатор
    )
)
RETURN s.фамилия;

// 14. Запросы с использованием агрегатных функций

// Определить количество различных растений, купленных садоводами из "Дальнего" в мае и июне
MATCH (r:Растение)<-[:КУПОНОВАЛ]-(b:Покупка)
WHERE b.питомник IN (SELECT идентификатор FROM Питомник WHERE товарищество = 'Дальнее') 
AND b.дата IN ['Май', 'Июнь']
RETURN COUNT(DISTINCT r.идентификатор);

// Определить на какую суммарную стоимость было продано саженцев вишни
MATCH (b:Покупка)-[:КУПОНОВАЛ]->(r:Растение {сорт: 'Вишня'})
RETURN SUM(b.итоговая_стоимость);

// Какие садоводы делали покупки на сумму выше средней
MATCH (s:Садовод)
WHERE s.идентификатор IN (
    MATCH (b:Покупка) 
    GROUP BY b.садовод 
    HAVING SUM(b.итоговая_стоимость) > (SELECT AVG(сумма) FROM (SELECT SUM(b.итоговая_стоимость) AS сумма FROM Покупка GROUP BY b.садовод) TEMP)
)
RETURN s.фамилия;

// Какие питомники продавали растения всем садоводам со льготами меньше средних
MATCH (p:Питомник)
WHERE NOT EXISTS (
    MATCH (s:Садовод WHERE s.льгота < (SELECT AVG(льгота) FROM Садовод))
    WHERE NOT EXISTS (
        MATCH (b:Покупка) WHERE b.питомник = p.идентификатор AND b.садовод = s.идентификатор
    )
)
RETURN p.название;

// 15. Запросы с использованием группировки

// Для каждого растения определить общее число различных покупателей
MATCH (r:Растение)<-[:КУПОНОВАЛ]-(b:Покупка)
RETURN r.сорт, COUNT(DISTINCT b.садовод) AS кол_покупателей 
GROUP BY r.сорт;

// Найти месяца, когда из питомников "Дальнего" покупали растений на общую сумму более 700000
MATCH (b:Покупка)
WHERE b.питомник IN (SELECT идентификатор FROM Питомник WHERE товарищество = 'Дальнее')
GROUP BY b.дата 
HAVING SUM(b.итоговая_стоимость) > 700000;

// Для каждой пары "садовод-растение" определить общее количество купленных саженцев
MATCH (b:Покупка)
GROUP BY b.садовод, b.растение 
RETURN b.садовод, b.растение, SUM(b.количество) AS общее_кол_во;

// Какие садоводы приобрели саженцев крыжовника на общую сумму более 300000
MATCH (b:Покупка)
WHERE b.растение IN (SELECT идентификатор FROM Растение WHERE сорт = 'Крыжовник') 
GROUP BY b.садовод 
HAVING SUM(b.итоговая_стоимость) > 300000
RETURN b.садовод;
